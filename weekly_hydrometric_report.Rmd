---
title: "Weekly Hydrometric Water Level Report"
author: "DFO"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output: 
  html_document:
    keep_md: yes
params: 
  stations: 
    - "09AG001"
    - "09CA002"
  YOI: 2024
---


```{r setup, echo = FALSE, results='asis', warning=FALSE, message=FALSE}

cat('<img src="images/DFO_logo.png" alt="logo" style="position:absolute; top:0; right:0; padding:10px;">')
  cat('\n\n<!-- -->\n\n')
  cat('\n\n<!-- -->\n\n')
  cat('\n\n<!-- -->\n\n')



library(rmarkdown)
library(dplyr)
library(ggplot2)
library(lubridate)
library(tidyhydat)
library(hydroGraphR)
library(flextable)
library(kableExtra)
library(purrr)
library(formattable)
library(data.table)
library(htmltools)
library(knitr)
library(htmlwidgets)

source("R/getQ.R")



```
## **Summary of water level, discharge and water level changes**

##### Level data is pulled from historical and real-time hydrometric data published by Water Survey of Canada.


---

```{r create def table, echo=FALSE, results='asis'}

# Create a data frame with definitions
definitions <- data.frame(
  Term = c("Station Number", "Parameter", "Mean (Today)",
           "Historical Mean (Today)", "Percent of Historical",
           "MAD", "Q25 (Today)", "Q75 (Today)", "72 Hr Change", "Trajectory"),
  
  Definition = c("WSC station number.", 
                 "Parameter type, either flow or water level.",
                 "The average value of today's (or most recent date captured) measurements.",
                 "The average value of the measurements on this date over the historical period.",
                 "The percentage of today's value compared to the historical average.",
                 "Mean Absolute Deviation, a measure of variability from the historical mean.",
                 "The 25th percentile of today's data distribution, indicating that 25% of the data points are below this value.",
                 "The 75th percentile of today's data distribution, indicating that 75% of the data points are below this value.",
                 "The change in the measurement over the past 72 hours.",
                 "The trend or direction of the measurement over a three day period.")
)

# Create the kable table
kable(definitions, "html", escape = FALSE, col.names = c("Term", "Definition")) %>%
  kable_styling(full_width = TRUE, position = "left") %>%
  row_spec(0, bold = TRUE, background = "#f0f0f0")

```

---

```{r read data, include=FALSE}

stations <- params$stations

# Accessing the YOI parameter
YOI <- params$YOI

message("Downloading hydro data...")
all_stations_data <- hydroGraphR::dl_hydro(stations)

uniq_stns <- all_stations_data %>% 
  distinct(STATION_NUMBER) 

uniq_stns <- uniq_stns$STATION_NUMBER


```



```{r stations data, include = FALSE,  results='asis'}

# gradient_color -----------------------------------

format_color <- function(x) {
  ifelse(x < 80, formattable::color_tile("red", "#FFFFEE")(x), color_tile("#EEFFEF", "olivedrab")(x))
}

# ---------------------------------------------------

format_mean <- function(x, Q25, Q75) {
  formattable::formatter("span", style = ~ formattable::style(
    background = ifelse(x >= Q25 & x <= Q75, "#bef7a6", "#f7a6a6")
  ))(x)
}

```

``` {r loop chunk, echo=FALSE, results='asis',  fig.width = 11, fig.height = 5, message = FALSE, warning = FALSE}


walk(uniq_stns, function(st){
  
  st_df <- all_stations_data %>% 
    filter(STATION_NUMBER %in% st)
  
  max_date <-as.Date(paste(as.character(params$YOI-1), "12", "31", sep = "-"))
  

  stats_table_raw <- create_stats_table(st_df, YOI = YOI)
  
  cat('\n\n<!-- -->\n\n')
  cat(paste0("### ", unique(stats_table_raw$station_name), "\n\n"))
  cat('\n\n<!-- -->\n\n')

  stats_table <- stats_table_raw %>% select(-station_name)
  
  colnames(stats_table) <- c("Station Number", "Parameter", "Mean (Today)",
                             "Historical Mean (Today)", "Percent of Historical", "MAD",
                             "Q25 (Today)", "Q75 (Today)",  "72 Hr Change", "Trajectory")
  
# Add formatting to Formatted Mean column which will eventually get changed to Historical Mean
  stats_table <- stats_table %>%
    rowwise() %>%
    mutate(`Formatted Mean (Today)` = list(format_mean(`Historical Mean (Today)`,
                                                     `Q25 (Today)`,
                                                     `Q75 (Today)`)))

# Unnest the formatted column for correct display
  stats_table <- stats_table %>% 
    ungroup() %>%
    mutate(`Formatted Mean (Today)` = sapply(`Formatted Mean (Today)`, as.character))


#  save formattable table to be printed
  formattable_table <- formattable(stats_table %>% 
                                  select(-`Historical Mean (Today)`, `Q25 (Today)`, `Q75 (Today)`) %>%
                                  rename(`Historical Mean (Today)` = `Formatted Mean (Today)`) %>%
                                   select("Station Number", "Parameter", "Mean (Today)", "Historical Mean (Today)",
                                          "Percent of Historical", "MAD", "Q25 (Today)", "Q75 (Today)",  "72 Hr Change", "Trajectory"))


# Convert to HTML and style the table
  html_table <- knitr::kable(formattable_table,
                           "html",
                           escape = FALSE, 
                           align = "c") %>%
  kable_styling(full_width = TRUE) %>%
  row_spec(row = 0, color = "white", background = "#0097A9") 

  print(html_table)
  cat("<br>") # Adds extra space




  
  st_df_past <- create_hydro_stats_historical(st_df, date_minimum = NA, date_maximum = max_date)
  sf_df_currentYr <- create_hydro_stats_singleYr(st_df, params$YOI, WY = "no")

  
  # SET UP HYDROGRAPH ------------------------------------------------


  print(hydroGraphR::create_hydrograph_separate(all_hydro_sites_historical = st_df_past,
                                              all_hydro_sites_1yr = sf_df_currentYr, 
                                              parameter = "flow",
                                              output_type = "print"))


  cat('\n\n<!-- -->\n\n')

  #line across
  cat("<hr>")
  
    
  cat("<br>") # Adds extra space

    
})


```









